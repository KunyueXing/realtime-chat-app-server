# realtime-chat-app-server

## Summary

## Outline

- [1 Key Features](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#key-features)
- [2 Tech Stack / Dependencies](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#tech-stack--dependencies)
- 3 Architecture Overview
- [4 Data Models](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#data-models)
- [5 API Architecture](docs/APIDesign.yaml)
  - [5.1 REST API Design (OpenAPI)](https://github.com/KunyueXing/realtime-chat-app-server/edit/main/README.md#rest-api-design-openapi))
  - [5.2 Controllers and Endpoint Mapping](https://github.com/KunyueXing/realtime-chat-app-server/edit/main/README.md#controllers-and-endpoint-mapping)
  - [5.3 WebSocket Event Design](https://github.com/KunyueXing/realtime-chat-app-server/edit/main/README.md#websocket-event-design)
- 6 Installation & Setup
- 7 Deployment
- [8 Usage](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#usage)
  - [8.1 API testing instructions (Postman)](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#api-testing-instructions-postman)
  - 8.2 How to test chat messages
- [9 Security Notes](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#security-notes)
- 10 Known Issues / Limitations
  - 10.1 Features under development
  - 10.2 Current Issues
- 11 Acknowledgements

## 1 Key Features

- User authentication and authorization
- Real-time 1:1 messaging
- Group chat with admin roles
- AI assistant via OpenAI
- Audio/video call support
- Message starring
- Media uploads via AWS S3

## 2 Tech Stack / Dependencies

- Runtime & Framework:
  - **Node.js, Express.js**
- Database:
  - **MongoDB** (Compass for GUI) - NoSQL database to store user profiles, chats, messages, and other structured data
  - **Mongoose** - Object Data Modeling (ODM) for MongoDB
  - **AWS S3** - file storage
- Real-time Communication:
  - **Socket.IO**
- Authentication & Authorization:
  - **jsonwebtoken (JWT)** – Secure token-based user authentication
  - **cookie-parser & cookie-session** – Parse and manage cookies for session handling
  - **bcryptjs** – Password hashing and verification
  - **otp-generator** – Generate OTPs for verification flows (e.g., email/phone verification)
- Email Service:
  - **SendGrid** – Transactional email delivery for signup verification, password reset, etc.
- Environment & Utilities:
  - **dotenv** – Manage environment variables
  - **cors** – Enable/disable cross-origin requests
  - **morgan** – HTTP request logger middleware for debugging and monitoring
  - **nodemon** – Auto-restarts server during development
- Audio / Video Services
- optional:
  - **Docker, AWS EC2, Kubernetes**

## 3 Architecture Overview

## 4 Data Models

This project uses **MongoDB** for storing users, groups, messages, and other structured data, and **AWS S3** for storing images, files, and attachments. Below are the main data models used in the backend. <br>

Only the User and Invitation Requests data models are detailed in this section; for descriptions of other models, please refer to [docs/dataModelsDesign.md](docs/dataModelsDesign.md).

#### User

```js
{
  _id: ObjectId,                   // Generated by MongoDB when the user is created
  firstName: String,               // Required
  lastName: String,                // Required
  username: String,                // Unique, for display
  email: String,                   // Required, Unique, valid address
  password: String,                // Required, minLength: 6
  passwordConfirm: String,         // Required when register, select: false -- not stored in the database
  passwordChangedAt: Date,
  passwordResetToken: String,
  passwordResetExpires: String,
  otp: String,                     // For verification
  otpExpiryTime: Date,
  avatarUrl: String,               // S3 URL for user avatar
  about: String,
  friends: [ObjectId],             // Ref: User _ids
  groups: [ObjectId],              // Ref: Group _ids
  emailVerified: Boolean,          // Default: false
  createdAt: Date,                 // Default: Date.now()
  updatedAt: Date,
  status: "online" | "offline",
  socketId: String,
  chats: [ObjectId],               // Ref: Chat _ids
  notifications: [ObjectId],       // Ref: Notification _ids
  invitationRequests: [ObjectId],  // Ref: Invitation Request _ids
  collections: [ObjectId]          // Ref: Collection _ids
}
```

---

#### Invitation Request (friend, group invitation)

```js
{
  _id: ObjectId,
  sender: ObjectId,                             // Ref: User _ids
  receiver: ObjectId,                           // Ref: User _ids
  createdAt: Date,                              // Default: Date.now()
  content: String,
  status: "pending" | "accepted" | "rejected",
}
```

---

**Notes:**

- All media (images, files, videos, audios, documents, and avatars) are stored in AWS S3, with only the metadata and S3 URLs stored in MongoDB.
- All references are MongoDB `ObjectId` types. References (`ObjectId`) are used for relations (users, chats, messages, groups, etc).
- Timestamps (`createdAt`, `updatedAt`) are used for sorting and auditing.
- Data models can be further normalized or denormalized based on performance and scaling requirements.
- Embedded arrays (e.g., starred messages, group members) for fast access, but may be normalized if lists become very large.
- Timestamps on all models to help with sorting and querying.
- AI chat is modeled as a specific chat type or even a special chat per user.

---

## 5 API Architecture

This section outlines how clients interact with the backend through REST APIs and real-time WebSocket connections.

### 5.1 REST API Design (OpenAPI)

This backend exposes a comprehensive REST API following OpenAPI 3.0 specification standards. The API is organized around resource-based endpoints with consistent patterns for authentication, user management, messaging, and real-time communication setup.

#### Key Features:

- RESTful Design - Standard HTTP methods (`GET`, `POST`, `PATCH`, `DELETE`) with intuitive resource naming
- Versioned API - All endpoints prefixed with `/api/v1` for backward compatibility
- JWT Authentication - Secure token-based authentication with protected routes
- Consistent Response Format - Standardized JSON responses with proper HTTP status codes
- Comprehensive Coverage - Supports user registration/authentication, friend management, chat operations, group functionality, media handling, and administrative features

#### API Highlights:

- Authentication Flow - Complete user registration, email verification, login/logout, and password recovery
- Social Features - Friend requests, user search, and relationship management
- Messaging Foundation - Chat creation, message CRUD operations, and media/file handling
- Group Management - Group chat creation, member management, and invitation system
- Real-time Setup - HTTP endpoints that work in conjunction with WebSocket events for hybrid communication

The API follows standard REST conventions while providing the necessary endpoints to support a full-featured real-time chat application. All endpoints include proper validation, error handling, and are designed to work seamlessly with the WebSocket event system for real-time features. For detailed descriptions, find the design in [docs/APIDesign.yaml](docs/APIDesign.yaml)

---

### 5.2 Controllers and Endpoint Mapping

This backend project is organized using modular controllers, each responsible for a distinct feature set. Below are the main controllers, their responsibilities, the API endpoints they handle, and the protocol implemented. <br>

**HTTP Only** for operations:

- CRUD-focused
- Doesn't need real-time delivery
- Request-response pattern fits perfectly

Examples:

```
// Authentication & User Management
register, login, logout, forgotPassword, resetPassword
getProfile, updateProfile, searchUsers, getUserById

// Settings & Preferences
pinChat, unpinChat, starMessage, unstarMessage
```

**HTTP + WebSocket** used for the operations:

- persistent storage + real-time delivery
- reliability + immediate feedback

Examples:

```
// Messages (persist + broadcast)
sendMessage, editMessage, deleteMessage, sendAIMessage

// Calls (log + signal)
startAudioCall, startVideoCall, endAudioCall, endVideoCall

// Group management with real-time updates
createGroup, inviteMembers, removeMember, leaveGroup
```

Only the AuthController and FriendController are detailed in this section; for descriptions of other models, please refer to [docs/ControllerAPIDesign.md](docs/ControllerAPIDesign.md).

#### AuthController

Handles user authentication, registration, and verification.

| Function       | HTTP Method | Endpoint                     | Description            | Protocol | Request Body                         |
| -------------- | ----------- | ---------------------------- | ---------------------- | -------- | ------------------------------------ |
| register       | POST        | /api/v1/auth/register        | User registration      | HTTP     | `{email: string, password: string, lastName: string, firstName: string}`  |
| verifyOTP      | POST        | /api/v1/auth/verify          | Email verification     | HTTP     | `{otp: string, email: string}`       |
| login          | POST        | /api/v1/auth/login           | User login             | HTTP     | `{email: string, password: string}}` |
| logout         | POST        | /api/v1/auth/logout          | User logout            | HTTP     | `{userId: string}`                   |
| forgotPassword | POST        | /api/v1/auth/forgot-password | Request password reset | HTTP     | `{email: string}`                    |
| resetPassword  | POST        | /api/v1/auth/reset-password  | Reset password         | HTTP     | `{newPassword: string}`              |

---

#### FriendController

Handles friend management and requests.

| Function            | HTTP Method | Endpoint                                    | Description           | Protocol         | HTTP Request Body                        |
| --------------------| ----------- | ------------------------------------------- | --------------------- | ---------------- | ---------------------------------------- |
| sendFriendRequest   | POST        | /api/v1/friends/requests                    | Send friend request   | HTTP + WebSocket | `{receiverId: string, senderId: string}` |
| acceptFriendRequest | POST        | /api/v1/friends/requests/{requestId}/accept | Accept friend request | HTTP + WebSocket | `{requestId: string, userId: string}`    |
| rejectFriendRequest | POST        | /api/v1/friends/requests/{requestId}/reject | Reject friend request | HTTP             | `{requestId: string, userId: string}`    |
| listFriends         | GET         | /api/v1/friends                             | List all friends      | HTTP             | None                                     |
| listFriendRequests  | GET         | /api/v1/friends/requests                    | List friend requests  | HTTP             | None                                     |
| removeFriend        | DELETE      | /api/v1/friends/{friendUserId}              | Remove friend         | HTTP             | `{userId: string, friendId: string}`     |

---

**Notes:**

- All endpoints are prefixed with `/api/v1` for versioning and API separation.
- Controllers can be further split or merged as the project scales.

---

### 5.3 WebSocket Event Design

This backend implements a comprehensive WebSocket event system using Socket.IO to enable real-time communication and live updates throughout the chat application. The WebSocket layer works in conjunction with the REST API to provide instant message delivery, live notifications, and real-time call signaling.

#### Key Features:

- Real-time Message Delivery - Instant message broadcasting to chat participants without HTTP polling
- Live Status Updates - Real-time typing indicators, user presence, and online/offline status
- WebRTC Signaling - Coordination for audio/video calls including offer/answer exchange and ICE candidates (actual media flows peer-to-peer via WebRTC)
- Push Notifications - Instant delivery of friend requests, message notifications, and system alerts
- Room-based Architecture - Users join specific chat rooms for efficient message routing and bandwidth optimization

#### Architecture Highlights:

- Hybrid Communication - Socket.IO events complement HTTP endpoints for reliability (HTTP for persistence + Socket.IO for real-time delivery)
- Connection Management - Automatic reconnection with Socket.IO's built-in fallback to HTTP long-polling on WebSocket connection loss
- Scalable Design - Room-based event routing to minimize unnecessary broadcasts and server load
- Security Integration - JWT token validation for Socket.IO connections with user authorization

Socket events to handle friend requests are listed here. For the rest detailed design, find in [docs/SocketEventDesign.md](docs/SocketEventDesign.md)

#### Friend Requests

| Event Name                | Emitter | Receiver | Payload                                                          | Description                 |
| ------------------------- | ------- | -------- | ---------------------------------------------------------------- | --------------------------- |
| `send_friend_request`     | Client  | Server   | `{ senderId: string, receiverId: string, friendRequest: object}` | Send friend request         |
| `new_friend_request`      | Server  | Client   | `{ friendRequest: object, senderId: string }`                    | Notify new friend request   |
| `accept_friend_request`   | Client  | Server   | `{ acceptedBy: string, requestSender: string }`                  | Accept friend request       |
| `friend_request_accepted` | Server  | Client   | `{ friend: object  }`                                            | Result of accepting request |

---

## 6 Installation & Setup

## 7 Deployment

## 8 Usage

### 8.1 API testing instructions (Postman)

The server's REST API is tested via Postman. Below are example requests and usage instructions

#### Authentication

Register a new user:

```
POST /api/v1/auth/register
Content-Type: application/json
{
	"firstName": "Jenny",
	"lastName": "Smith",
	"email": "xxxx@gmail.com",
	"password": "xxxxxxxxx",
	"passwordConfirm": "xxxxxxxx"
}
```

Login and get token:

```
POST /api/v1/auth/login
Content-Type: application/json

{
	"email": "xxxx@gmail.com",
	"password": "xxxxxxxxx"
}
```

Reset password:

```
PATCH /api/v1/auth/resetPassword
Content-Type: application/json
{
	"password": "xxxxxxxxx",
	"passwordConfirm": "xxxxxxxxx",
	"token": "b9a68537..............."
}
```

**Notes:**

- All protected routes require an Authorization header: `Authorization: Bearer <your_token>`

### 8.2 How to test chat messages

## 9 Security Notes

- Security Headers
  - **Helmet** -- Sets various HTTP headers to protect against well-known web vulnerabilities (e.g., clickjacking, MIME sniffing, etc.)
- Rate Limiting & Request Control
  - **express-rate-limit** – Throttle repeated requests to public APIs and endpoints to prevent brute-force attacks
- Input Sanitization & XSS Protection
  - **express-mongo-sanitize** – Prevents NoSQL injection by removing prohibited characters in MongoDB queries
  - **xss** – Sanitizes user input to prevent Cross-site scripting (XSS) attacks
- Cookie Security
  - **cookie-parser** – Parses and verifies signed cookies
  - **cookie-session** – Provides secure and efficient session management
- CORS Configuration
  - **cors** – Configured to allow only trusted domains and control HTTP methods and headers allowed by the server
- Authentication & Authorization:
  - **JWT** -- to implement stateless and secure authentication.
    - The token is then used to authenticate requests to protected routes and it was passed via authorization: Bearer <token> header (preferred)
    - Token expiration: JWTs expire after a configurable period (e.g., 1 hour).
    - Secure storage: tokens are stored in secure, HTTP-only cookies to mitigate XSS attacks.
- HTTPS usage (optional)
  - Deploy behind HTTPS (e.g., with a reverse proxy like NGINX or use AWS ALB/Cloudflare) for production

## 10 Known Issues / Limitations

### 10.1 Features under development

### 10.2 Current Issues

## 11 Acknowledgements
