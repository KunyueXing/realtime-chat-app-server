# realtime-chat-app-server

## Design
### Data Model
This project uses **MongoDB** for storing users, groups, messages, and other structured data, and **AWS S3** for storing images, files, and attachments. Below are the main data models used in the backend. 
#### 1 User
```js
{
  _id: ObjectId,                   // Generated by MongoDB when the user is created
  firstName: String,               // Required
  lastName: String,                // Required
  username: String,                // Unique, for display
  email: String,                   // Required, Unique, valid address
  password: String,                // Required, minLength: 6
  passwordConfirm: String,         // Required when register, select: false -- not stored in the database
  passwordChangedAt: Date,
  passwordResetToken: String,
  passwordResetExpires: String,
  otp: String,                     // For verification
  otpExpiryTime: Date,
  avatarUrl: String,               // S3 URL for user avatar
  about: String,
  friends: [ObjectId],             // Ref: User _ids
  groups: [ObjectId],              // Ref: Group _ids
  emailVerified: Boolean,          // Default: false
  createdAt: Date,                 // Default: Date.now()
  updatedAt: Date,
  status: "online" | "offline",
  socketId: String,
  chats: [ObjectId],               // Ref: Chat _ids
  notifications: [ObjectId],       // Ref: Notification _ids
  invitationRequests: [ObjectId],  // Ref: Invitation Request _ids
  collections: [ObjectId]          // Ref: Collection _ids
}
```
#### 2 Invitation Request (friend, group invitation)
```js
{
  _id: ObjectId,
  sender: ObjectId,                             // Ref: User _ids
  receiver: ObjectId,                           // Ref: User _ids
  createdAt: Date,                              // Default: Date.now()
  content: String,
  status: "pending" | "accepted" | "rejected",
}
```
#### 3 Chat (1:1 and group)
```js
{
  _id: ObjectId,
  isGroup: Boolean,
  name: String,               // For group chat
  participants: [ObjectId],   // Ref: User _ids (2 for 1:1, many for group)
  groupId: ObjectId,          // Ref: Group _id
  messages: [ObjectId],       // Ref: Message _ids
  lastMessage: ObjectId,      // Ref: Message _id
  pinnedBy: [ObjectId],       // Ref: User _ids -- who pinned this chat
  createdAt: Date,            // Default: Date.now()
  updatedAt: Date
}
```
#### 4 Group
```js
{
  _id: ObjectId,
  name: String,
  members: [ObjectId],       // User _ids
  admins: [ObjectId],        // User _ids
  invited: [ObjectId],       // User _ids (pending invitations)
  createdAt: Date,           // Default: Date.now()
  updatedAt: Date
}
```
#### 5 Message
```js
{
  _id: ObjectId,
  chatId: ObjectId,                                                       // Ref: Chat _id
  groupId: ObjectId,                                                      // Ref: Group _id -- If group message
  sender: ObjectId,                                                       // Ref: User _id
  content: String,                                                        // Text content
  type: "text" | "image" | "file" | "link" | "emoji" | "video"| "audio",
  attachments: [ObjectId],                                                // Ref: Media _id -- for image/file/link/emoji/video/audio
  starredBy: [ObjectId],                                                  // Users who starred this message
  readBy: [ObjectId],                                                     // Users who have read the message
  createdAt: Date,
  updatedAt: Date,
  deleted: Boolean
}
```
#### 6 AI Chat
```js
{
  _id: ObjectId,
  userId: ObjectId,           // Ref: User _id
  messages: [ObjectId],       // Ref: Message _ids
  pinned: true,
  createdAt: Date,
  updatedAt: Date
}
```
#### 7 Notification

```js
{
  _id: ObjectId,
  userId: ObjectId,
  type: "message" | "friend_request" | "group_invite"
  content: String,
  relatedId: ObjectId,                                  // e.g., messageId, groupId
  read: Boolean,
  createdAt: Date
}
```
#### 8 Call (for audio/video calls)

```js
{
  _id: ObjectId,
  type: "audio" | "video",
  chatId: ObjectId,                          // Ref: Chat _id
  groupId: ObjectId,                         // Ref: Group _id
  initiator: ObjectId,                       // Ref: User _id
  participants: [ObjectId],                  // Ref: User _ids
  startedAt: Date,
  endedAt: Date,
  status: "ongoing" | "ended" | "missed"
}
```

#### Media (for Attachment Metadata)
```js
{
  _id: ObjectId,
  uploader: ObjectId,                             // Ref: User _id
  chatId: ObjectId,                               // Ref: Chat _id
  groupId: ObjectId,                              // Ref: Group _id
  type: "image" | "file" | "video" | "audio",
  url: String,                                    // S3 URL
  fileType: String,
  name: String,
  size: Number,
  uploadedAt: Date
}
```
#### Collection (for lists of starred messages, lists of image|video|file)
```js
{
  _id: ObjectId,
  chatId: ObjectId,                            // Ref: Chat _id
  owner: ObjectId,                             // Ref: User _id
  starredMessages: [ObjectId],                 // Ref: Message _ids
  attachments: [ObjectId],                     // Ref: Media _ids
}
```


**Notes:**
- All media (images, files, avatars) are stored in AWS S3, with only the metadata and S3 URLs stored in MongoDB.
- All references are MongoDB `ObjectId` types.
- Timestamps (`createdAt`, `updatedAt`) are used for sorting and auditing.
- Data models can be further normalized or denormalized based on performance and scaling requirements.
