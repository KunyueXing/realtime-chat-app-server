# realtime-chat-app-server
## Summary

## Outline
* [Key Features](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#key-features)
* [Tech Stack / Dependencies](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#tech-stack--dependencies)
* Architecture Overview
* [Data Models](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#data-models)
* API Reference
* [Controllers and API Design](https://github.com/KunyueXing/realtime-chat-app-server/edit/main/README.md#controllers--api-design)
* Socket.IO Events
* Installation & Setup
* Deployment
* [Usage](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#usage)
  * [API testing instructions (Postman)](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#api-testing-instructions-postman)
  * How to test chat messages
* [Security Notes](https://github.com/KunyueXing/realtime-chat-app-server/tree/main?tab=readme-ov-file#security-notes)
* Known Issues / Limitations
  * Features under development
  * Current Issues
* Acknowledgements

## Key Features
* User authentication and authorization
* Real-time 1:1 messaging
* Group chat with admin roles
* AI assistant via OpenAI
* Audio/video call support
* Message starring
* Media uploads via AWS S3

## Tech Stack / Dependencies
* Runtime & Framework:
	* **Node.js, Express.js**
* Database:
  * **MongoDB** (Compass for GUI) - NoSQL database to store user profiles, chats, messages, and other structured data
  * **Mongoose** - Object Data Modeling (ODM) for MongoDB
  * **AWS S3** - file storage
* Real-time Communication:
	* **Socket.IO**
* Authentication & Authorization:
  * **jsonwebtoken (JWT)** – Secure token-based user authentication
  * **cookie-parser & cookie-session** – Parse and manage cookies for session handling
  * **bcryptjs** – Password hashing and verification
  * **otp-generator** – Generate OTPs for verification flows (e.g., email/phone verification)
* Email Service:
  * **SendGrid** – Transactional email delivery for signup verification, password reset, etc.
* Environment & Utilities:
	* **dotenv** – Manage environment variables
  * **cors** – Enable/disable cross-origin requests
  * **morgan** – HTTP request logger middleware for debugging and monitoring
  * **nodemon** – Auto-restarts server during development
* Audio / Video Services
* optional:
	* **Docker, AWS EC2, Kubernetes**

## Architecture Overview

## Data Models
This project uses **MongoDB** for storing users, groups, messages, and other structured data, and **AWS S3** for storing images, files, and attachments. Below are the main data models used in the backend. <br>

Only the User and Invitation Requests data models are detailed in this section; for descriptions of other models, please refer to [docs/dataModelsDesign.md](docs/dataModelsDesign.md).
#### 1 User
```js
{
  _id: ObjectId,                   // Generated by MongoDB when the user is created
  firstName: String,               // Required
  lastName: String,                // Required
  username: String,                // Unique, for display
  email: String,                   // Required, Unique, valid address
  password: String,                // Required, minLength: 6
  passwordConfirm: String,         // Required when register, select: false -- not stored in the database
  passwordChangedAt: Date,
  passwordResetToken: String,
  passwordResetExpires: String,
  otp: String,                     // For verification
  otpExpiryTime: Date,
  avatarUrl: String,               // S3 URL for user avatar
  about: String,
  friends: [ObjectId],             // Ref: User _ids
  groups: [ObjectId],              // Ref: Group _ids
  emailVerified: Boolean,          // Default: false
  createdAt: Date,                 // Default: Date.now()
  updatedAt: Date,
  status: "online" | "offline",
  socketId: String,
  chats: [ObjectId],               // Ref: Chat _ids
  notifications: [ObjectId],       // Ref: Notification _ids
  invitationRequests: [ObjectId],  // Ref: Invitation Request _ids
  collections: [ObjectId]          // Ref: Collection _ids
}
```
---
#### 2 Invitation Request (friend, group invitation)
```js
{
  _id: ObjectId,
  sender: ObjectId,                             // Ref: User _ids
  receiver: ObjectId,                           // Ref: User _ids
  createdAt: Date,                              // Default: Date.now()
  content: String,
  status: "pending" | "accepted" | "rejected",
}
```
---


**Notes:**
- All media (images, files, videos, audios, documents, and avatars) are stored in AWS S3, with only the metadata and S3 URLs stored in MongoDB.
- All references are MongoDB `ObjectId` types. References (`ObjectId`) are used for relations (users, chats, messages, groups, etc).
- Timestamps (`createdAt`, `updatedAt`) are used for sorting and auditing.
- Data models can be further normalized or denormalized based on performance and scaling requirements.
- Embedded arrays (e.g., starred messages, group members) for fast access, but may be normalized if lists become very large.
- Timestamps on all models to help with sorting and querying.
- AI chat is modeled as a specific chat type or even a special chat per user.

## API Reference

## Controllers & API Design
This backend project is organized using modular controllers, each responsible for a distinct feature set. Below are the main controllers, their responsibilities, and the API endpoints they handle. <br>

Only the AuthController and UserController are detailed in this section; for descriptions of other models, please refer to [docs/ControllerAPIDesign.md](docs/ControllerAPIDesign.md).

### AuthController

Handles user authentication, registration, and verification.

| Function               | HTTP Method | Endpoint                        | Description                     |
|------------------------|-------------|----------------------------------|---------------------------------|
| register               | POST        | /api/v1/auth/register           | User registration               |
| verifyOTP              | POST        | /api/v1/auth/verify             | Email verification              |
| login                  | POST        | /api/v1/auth/login              | User login                      |
| logout                 | POST        | /api/v1/auth/logout             | User logout                     |
| forgotPassword         | POST        | /api/v1/auth/forgot-password    | Request password reset          |
| resetPassword          | POST        | /api/v1/auth/reset-password     | Reset password                  |

---
### UserController

Manages user profiles and user settings.

| Function        | HTTP Method | Endpoint                         | Description                  |
|-----------------|-------------|-----------------------------------|------------------------------|
| getProfile      | GET         | /api/v1/users/me                 | Get current user profile     |
| updateProfile   | PATCH       | /api/v1/users/me                 | Update current user profile  |
| searchUsers     | GET         | /api/v1/users/search             | Search for users             |
| getUserById     | GET         | /api/v1/users/{userId}           | Get other users' profile data by ID|
| listNonFriends  | GET         | /api/v1/users/non-friends        | List users who are not friends with the authenticated user |

---
**Notes:**
- All endpoints are prefixed with `/api/v1` for versioning and API separation.
- Controllers can be further split or merged as the project scales.

## Socket.IO Events

## Installation & Setup

## Deployment

## Usage
  ### API testing instructions (Postman)
  The server's REST API is tested via Postman. Below are example requests and usage instructions
  #### Authentication
  Register a new User
```
POST /api/v1/auth/register
Content-Type: application/json
{
	"firstName": "Jenny",
	"lastName": "Smith",
	"email": "xxxx@gmail.com",
	"password": "xxxxxxxxx",
	"passwordConfirm": "xxxxxxxx"
}
```
	
Login and get token
```
POST /api/v1/auth/login
Content-Type: application/json

{
	"email": "xxxx@gmail.com",
	"password": "xxxxxxxxx"
}
```

Reset password
```
PATCH /api/v1/auth/resetPassword
Content-Type: application/json
{
	"password": "xxxxxxxxx",
	"passwordConfirm": "xxxxxxxxx",
	"token": "b9a68537..............."
}
```

**Notes:**
- All protected routes require an Authorization header: `Authorization: Bearer <your_token>`
  
### How to test chat messages

## Security Notes
* Security Headers
    * **Helmet** -- Sets various HTTP headers to protect against well-known web vulnerabilities (e.g., clickjacking, MIME sniffing, etc.)
* Rate Limiting & Request Control
    * **express-rate-limit** – Throttle repeated requests to public APIs and endpoints to prevent brute-force attacks
* Input Sanitization & XSS Protection
    * **express-mongo-sanitize** – Prevents NoSQL injection by removing prohibited characters in MongoDB queries
    * **xss** – Sanitizes user input to prevent Cross-site scripting (XSS) attacks
* Cookie Security
    * **cookie-parser** – Parses and verifies signed cookies
    * **cookie-session** – Provides secure and efficient session management
* CORS Configuration
    * **cors** – Configured to allow only trusted domains and control HTTP methods and headers allowed by the server
* Authentication & Authorization: 
    * **JWT** -- to implement stateless and secure authentication.
        * The token is then used to authenticate requests to protected routes and it was passed via authorization: Bearer <token> header (preferred)
        * Token expiration: JWTs expire after a configurable period (e.g., 1 hour).
        * Secure storage: tokens are stored in secure, HTTP-only cookies to mitigate XSS attacks.
* HTTPS usage (optional)
    * Deploy behind HTTPS (e.g., with a reverse proxy like NGINX or use AWS ALB/Cloudflare) for production

## Known Issues / Limitations
  ### Features under development
  ### Current Issues
## Acknowledgements
